# Docker Compose configuration for GetLegalAid web application
# This file is optimized for Dokploy VPS deployment

version: '3.8'

services:
  # Main web application service
  web:
    # Build configuration
    build:
      context: .                    # Use current directory as build context
      dockerfile: Dockerfile        # Use our custom Dockerfile
    
    # Container configuration
    container_name: getlegalaid-web
    restart: unless-stopped         # Restart policy for production stability
    
    # Port mapping
    ports:
      - "80:80"                     # Map host port 80 to container port 80
      # If you need HTTPS, Dokploy typically handles SSL termination
      # - "443:443"                 # Uncomment if you need direct HTTPS
    
    # Environment variables for production
    environment:
      # API configuration - update this to your actual backend URL
      - VITE_API_BASE_URL=${API_BASE_URL:-http://localhost:8000}
      
      # Node environment
      - NODE_ENV=production
      
      # Add other environment variables as needed
      # - VITE_APP_NAME=GetLegalAid
      # - VITE_APP_VERSION=1.0.0
    
    # Health check configuration
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 30s                 # Check every 30 seconds
      timeout: 10s                  # Timeout after 10 seconds
      retries: 3                    # Retry 3 times before marking unhealthy
      start_period: 40s             # Wait 40s before first health check
    
    # Resource limits (adjust based on your VPS capacity)
    deploy:
      resources:
        limits:
          memory: 512M              # Limit memory usage to 512MB
          cpus: '0.5'               # Limit CPU usage to 0.5 cores
        reservations:
          memory: 256M              # Reserve at least 256MB
          cpus: '0.25'              # Reserve at least 0.25 cores
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"             # Maximum log file size
        max-file: "3"               # Keep maximum 3 log files
    
    # Labels for organization and monitoring
    labels:
      - "app=getlegalaid"
      - "service=web"
      - "environment=production"

# Optional: Add additional services like Redis, database, etc.
# Uncomment and configure as needed for your setup

# services:
#   # Redis for caching (if needed)
#   redis:
#     image: redis:7-alpine
#     container_name: getlegalaid-redis
#     restart: unless-stopped
#     ports:
#       - "6379:6379"
#     volumes:
#       - redis_data:/data
#     command: redis-server --appendonly yes
#     
#   # PostgreSQL database (if you need a database)
#   postgres:
#     image: postgres:15-alpine
#     container_name: getlegalaid-db
#     restart: unless-stopped
#     environment:
#       - POSTGRES_DB=getlegalaid
#       - POSTGRES_USER=getlegalaid
#       - POSTGRES_PASSWORD=${DB_PASSWORD:-changeme}
#     volumes:
#       - postgres_data:/var/lib/postgresql/data
#     ports:
#       - "5432:5432"

# Volumes for data persistence (uncomment if using additional services)
# volumes:
#   redis_data:
#   postgres_data:

# Network configuration (optional, Docker creates default network)
networks:
  default:
    name: getlegalaid-network